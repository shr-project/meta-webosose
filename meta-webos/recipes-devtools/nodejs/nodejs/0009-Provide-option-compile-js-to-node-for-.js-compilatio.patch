From efb078b3604fad0ea5d47cc8e1d1e307d8bbde4b Mon Sep 17 00:00:00 2001
From: Andrii Koval <andrii.koval@lge.com>
Date: Fri, 31 Jul 2015 11:48:20 +0300
Subject: [PATCH] Provide option "--compile-js" to node for .js compilation

:Release Notes:
Provide option "--compile-js" to node for .js compilation

:Detailed Notes:
Added option "--compile-js" to node for compilation JS files.
This option will work only if node is buit with option
--v8-options="-serialize_toplevel"
Steps to build node:
./configure --v8-options="-serialize_toplevel"
make
Using: node --compile-js input.js output.jsb

:Testing Performed:
Using new option, I locally compiled the set of different
*.js files.
All localy tests I performed using build #886

:QA Notes:

:Issues Addressed:
[PLAT-2298] Provide option to node for .js compilation

Change-Id: I93c0d93cda85b427498bc88cfa08921366c54eeb
Reviewed-on: https://gpro.lgsvl.com/115378
Reviewed-by: Andrii Koval <andrii.koval@lge.com>
Tested-by: Andrii Koval <andrii.koval@lge.com>
Reviewed-by: Denys Romanchuk <denys.romanchuk@lge.com>
Reviewed-by: Tigran Avanesov <tigran.avanesov@lge.com>
---
 node.gyp            |  1 +
 src/node.cc         | 18 +++++++++++
 src/node_options.cc |  2 ++
 src/node_options.h  |  1 +
 src/precompile.cc   | 86 +++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/precompile.h    | 28 +++++++++++++++++
 6 files changed, 136 insertions(+)
 create mode 100644 src/precompile.cc
 create mode 100644 src/precompile.h

diff --git a/node.gyp b/node.gyp
index a8de196..85d537f 100644
--- a/node.gyp
+++ b/node.gyp
@@ -392,6 +392,7 @@
         'src/udp_wrap.cc',
         'src/util.cc',
         'src/uv.cc',
+        'src/precompile.cc',
         # headers to make for a more pleasant IDE experience
         'src/aliased_buffer.h',
         'src/async_wrap.h',
diff --git a/src/node.cc b/src/node.cc
index 0b29a44..4dd8092 100644
--- a/src/node.cc
+++ b/src/node.cc
@@ -30,6 +30,7 @@
 #include "node_perf.h"
 #include "node_context_data.h"
 #include "tracing/traced_value.h"
+#include "precompile.h"
 
 #if defined HAVE_PERFCTR
 #include "node_counters.h"
@@ -176,6 +177,7 @@ static bool v8_is_profiling = false;
 static bool node_is_initialized = false;
 static uv_once_t init_modpending_once = UV_ONCE_INIT;
 static uv_key_t thread_local_modpending;
+static bool compile_mode = false;
 static node_module* modlist_builtin;
 static node_module* modlist_internal;
 static node_module* modlist_linked;
@@ -2797,6 +2799,19 @@ Environment* CreateEnvironment(IsolateData* isolate_data,
   return env;
 }
 
+static void CompileFile(int argc, const char* const* argv)
+{
+  if (argc < 3) {
+    fprintf(stderr, "Please enter input and output file names.\n");
+    exit(1);
+  }
+
+  if (node::PrecompileJS::Compile(argv[1], argv[2]) < 0) {
+     exit(1);
+  }
+
+  exit(0);
+}
 
 void FreeEnvironment(Environment* env) {
   env->RunCleanup();
@@ -2950,6 +2965,9 @@ inline int Start(uv_loop_t* event_loop,
   if (isolate == nullptr)
     return 12;  // Signal internal error.
 
+  if (compile_mode)
+    CompileFile(argc, argv);
+
   {
     Mutex::ScopedLock scoped_lock(node_isolate_mutex);
     CHECK_NULL(node_isolate);
diff --git a/src/node_options.cc b/src/node_options.cc
index 79dff7a..6950da5 100644
--- a/src/node_options.cc
+++ b/src/node_options.cc
@@ -102,6 +102,8 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {
             &EnvironmentOptions::experimental_worker,
             kAllowedInEnvironment);
   AddOption("--expose-internals", "", &EnvironmentOptions::expose_internals);
+  AddOption("--compile-js", "", &EnvironmentOptions::compile_js);
+
   AddOption("--loader",
             "(with --experimental-modules) use the specified file as a "
             "custom loader",
diff --git a/src/node_options.h b/src/node_options.h
index 4edec11..6058706 100644
--- a/src/node_options.h
+++ b/src/node_options.h
@@ -72,6 +72,7 @@ class EnvironmentOptions : public Options {
   bool experimental_vm_modules = false;
   bool experimental_worker = false;
   bool expose_internals = false;
+  bool compile_js = false;
   bool no_deprecation = false;
   bool no_force_async_hooks_checks = false;
   bool no_warnings = false;
diff --git a/src/precompile.cc b/src/precompile.cc
new file mode 100644
index 0000000..149a0d0
--- /dev/null
+++ b/src/precompile.cc
@@ -0,0 +1,86 @@
+// @@@LICENSE
+//
+// Copyright (c ) 2015 LG Electronics, Inc.
+//
+// Confidential computer software. Valid license from LG required for
+// possession, use or copying. Consistent with FAR 12.211 and 12.212,
+// Commercial Computer Software, Computer Software Documentation, and
+// Technical Data for Commercial Items are licensed to the U.S. Government
+// under vendor's standard commercial license.
+//
+// LICENSE@@@
+
+#include "node.h"
+#include "precompile.h"
+
+#include <iostream>
+#include <fstream>
+#include <stdio.h>
+#include <memory>
+#include <sstream>
+
+namespace node {
+namespace PrecompileJS {
+
+int Compile(const std::string& source_file_name, const std::string& cache_file_name)
+{
+  std::string err_str;
+  while (true) {
+    v8::Isolate *isolate = v8::Isolate::GetCurrent();
+    v8::HandleScope scope(isolate);
+
+    // open 'source_file_name' and read into string
+    std::ifstream in_file(source_file_name.c_str(), std::ifstream::binary);
+    if (!in_file.is_open()) {
+      std::ostringstream err_buf;
+      err_buf << "Can't open input file " << source_file_name;
+      err_str = err_buf.str();
+      break;
+    }
+
+    in_file.seekg(0, std::ios::end);
+    size_t in_file_size = in_file.tellg();
+    in_file.seekg(0, std::ios::beg);
+
+    std::string in_buf;
+    in_buf.reserve(in_file_size);
+    in_buf.assign((std::istreambuf_iterator<char>(in_file)), std::istreambuf_iterator<char>());
+    in_file.close();
+
+    // compile into unbound script
+    v8::Local<v8::String> source_str = v8::String::NewFromUtf8(isolate, in_buf.c_str());
+    v8::ScriptCompiler::Source source(source_str);
+
+    v8::ScriptCompiler::CompileUnbound(isolate, &source, v8::ScriptCompiler::kProduceCodeCache);
+
+    const v8::ScriptCompiler::CachedData *cache = source.GetCachedData();
+    if (!cache) {
+      err_str = "Failed to get cached data.";
+      break;
+    }
+
+    // save cached data in 'cache_file_name'
+    std::ofstream out_file(cache_file_name.c_str(), std::ofstream::binary);
+    if (!out_file.is_open()) {
+      std::ostringstream err_buf;
+      err_buf << "Can't open output file " << cache_file_name;
+      err_str = err_buf.str();
+      break;
+    }
+    out_file.write((const char*)cache->data, cache->length);
+    out_file.close();
+
+    fprintf(stdout, "Compilation completed. Result saved into %s.\n", cache_file_name.c_str());
+    break;
+  }
+
+  if (!err_str.empty()) {
+    fprintf(stderr, "Error: %s\n", err_str.c_str());
+    return -1;
+  }
+
+  return 0;
+}
+
+} // namespace PrecompileJS
+} // namespace node
diff --git a/src/precompile.h b/src/precompile.h
new file mode 100644
index 0000000..85e2bc5
--- /dev/null
+++ b/src/precompile.h
@@ -0,0 +1,28 @@
+// @@@LICENSE
+//
+// Copyright (c ) 2015 LG Electronics, Inc.
+//
+// Confidential computer software. Valid license from LG required for
+// possession, use or copying. Consistent with FAR 12.211 and 12.212,
+// Commercial Computer Software, Computer Software Documentation, and
+// Technical Data for Commercial Items are licensed to the U.S. Government
+// under vendor's standard commercial license.
+//
+// LICENSE@@@
+
+#ifndef SRC_PRE_COMPILE_JS_H_
+#define SRC_PRE_COMPILE_JS_H_
+
+#include "v8.h"
+#include <string>
+
+namespace node {
+namespace PrecompileJS {
+
+int Compile(const std::string& source_file_name, const std::string& cache_file_name);
+
+
+}  // namespace PrecompileJS
+}  // namespace node
+
+#endif  // SRC_PRE_COMPILE_JS_H_
